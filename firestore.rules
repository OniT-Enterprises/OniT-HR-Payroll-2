rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function authed() {
      return request.auth != null;
    }

    // Development mode helper
    function isDevelopment() {
      return request.auth.uid == 'development-user' ||
             request.auth.token.email == 'demo@example.com' ||
             request.auth.token.email_verified == false;
    }
    
    function hasTenant(tid) {
      return authed() && (
        tid in request.auth.token.tenants ||
        isDevelopment()
      );
    }
    
    function isTenantMember(tid) {
      return authed() && 
             exists(/databases/$(database)/documents/tenants/$(tid)/members/$(request.auth.uid));
    }
    
    function getTenantRole(tid) {
      return get(/databases/$(database)/documents/tenants/$(tid)/members/$(request.auth.uid)).data.role;
    }
    
    function hasRole(tid, role) {
      return isTenantMember(tid) && getTenantRole(tid) == role;
    }
    
    function isOwnerOrAdmin(tid) {
      return isTenantMember(tid) && 
             getTenantRole(tid) in ['owner', 'hr-admin'];
    }
    
    function canAccessModule(tid, module) {
      let memberData = get(/databases/$(database)/documents/tenants/$(tid)/members/$(request.auth.uid)).data;
      return memberData.role in ['owner', 'hr-admin'] || 
             (memberData.modules != null && module in memberData.modules);
    }

    // Tenant isolation - primary security boundary
    match /tenants/{tid} {
      // Tenant document itself
      allow read, write: if hasTenant(tid);
      
      // Tenant settings
      match /settings/config {
        allow read: if isTenantMember(tid);
        allow write: if isOwnerOrAdmin(tid);
      }
      
      // Member management
      match /members/{uid} {
        allow read: if isTenantMember(tid);
        allow write: if isOwnerOrAdmin(tid);
      }
      
      // Department management
      match /departments/{deptId} {
        allow read: if isTenantMember(tid) && canAccessModule(tid, 'staff');
        allow write: if isOwnerOrAdmin(tid) && canAccessModule(tid, 'staff');
      }
      
      // Employee management  
      match /employees/{empId} {
        allow read: if isTenantMember(tid) && canAccessModule(tid, 'staff');
        allow write: if isOwnerOrAdmin(tid) && canAccessModule(tid, 'staff');
      }
      
      // Position management
      match /positions/{posId} {
        allow read: if isTenantMember(tid) && canAccessModule(tid, 'staff');
        allow write: if isOwnerOrAdmin(tid) && canAccessModule(tid, 'staff');
      }
      
      // Hiring module
      match /jobs/{jobId} {
        allow read: if isTenantMember(tid) && canAccessModule(tid, 'hiring');
        allow write: if isOwnerOrAdmin(tid) && canAccessModule(tid, 'hiring');
      }
      
      match /candidates/{candId} {
        allow read: if isTenantMember(tid) && canAccessModule(tid, 'hiring');
        allow write: if isOwnerOrAdmin(tid) && canAccessModule(tid, 'hiring');
      }
      
      match /interviews/{intId} {
        allow read: if isTenantMember(tid) && canAccessModule(tid, 'hiring');
        allow write: if isOwnerOrAdmin(tid) && canAccessModule(tid, 'hiring');
      }
      
      match /offers/{offerId} {
        allow read: if isTenantMember(tid) && canAccessModule(tid, 'hiring');
        allow write: if isOwnerOrAdmin(tid) && canAccessModule(tid, 'hiring');
      }
      
      // Employment contracts and snapshots
      match /contracts/{contractId} {
        allow read: if isTenantMember(tid) && canAccessModule(tid, 'staff');
        allow write: if isOwnerOrAdmin(tid) && canAccessModule(tid, 'staff');
      }
      
      match /employmentSnapshots/{snapId} {
        allow read: if isTenantMember(tid) && canAccessModule(tid, 'staff');
        allow create: if isOwnerOrAdmin(tid) && canAccessModule(tid, 'staff');
        // Snapshots are immutable once created
        allow update, delete: if false;
      }
      
      // Time and leave module
      match /rosters/{ym}/shifts/{shiftId} {
        allow read: if isTenantMember(tid) && canAccessModule(tid, 'timeleave');
        allow write: if isOwnerOrAdmin(tid) && canAccessModule(tid, 'timeleave');
      }
      
      match /timesheets/{empId_weekIso} {
        allow read: if isTenantMember(tid) && canAccessModule(tid, 'timeleave');
        allow write: if isOwnerOrAdmin(tid) && canAccessModule(tid, 'timeleave');
      }
      
      match /leavePolicies/{policyId} {
        allow read: if isTenantMember(tid) && canAccessModule(tid, 'timeleave');
        allow write: if isOwnerOrAdmin(tid) && canAccessModule(tid, 'timeleave');
      }
      
      match /leaveRequests/{reqId} {
        allow read: if isTenantMember(tid) && canAccessModule(tid, 'timeleave');
        allow write: if isOwnerOrAdmin(tid) && canAccessModule(tid, 'timeleave');
      }
      
      match /leaveBalances/{empId_year} {
        allow read: if isTenantMember(tid) && canAccessModule(tid, 'timeleave');
        allow write: if isOwnerOrAdmin(tid) && canAccessModule(tid, 'timeleave');
      }
      
      // Performance module
      match /goals/{goalId} {
        allow read: if isTenantMember(tid) && canAccessModule(tid, 'performance');
        allow write: if isOwnerOrAdmin(tid) && canAccessModule(tid, 'performance');
      }
      
      match /reviews/{reviewId} {
        allow read: if isTenantMember(tid) && canAccessModule(tid, 'performance');
        allow write: if isOwnerOrAdmin(tid) && canAccessModule(tid, 'performance');
      }
      
      match /trainings/{trainingId} {
        allow read: if isTenantMember(tid) && canAccessModule(tid, 'performance');
        allow write: if isOwnerOrAdmin(tid) && canAccessModule(tid, 'performance');
      }
      
      match /discipline/{disciplineId} {
        allow read: if isTenantMember(tid) && canAccessModule(tid, 'performance');
        allow write: if isOwnerOrAdmin(tid) && canAccessModule(tid, 'performance');
      }
      
      match /promotionSignals/{year_q}/{empId} {
        allow read: if isTenantMember(tid) && canAccessModule(tid, 'performance');
        allow write: if isOwnerOrAdmin(tid) && canAccessModule(tid, 'performance');
      }
      
      // Payroll module
      match /payruns/{yyyymm}/payslips/{empId} {
        allow read: if isTenantMember(tid) && canAccessModule(tid, 'payroll');
        allow write: if isOwnerOrAdmin(tid) && canAccessModule(tid, 'payroll');
      }
      
      // Analytics and reports
      match /analytics/{docId} {
        allow read: if isTenantMember(tid) && canAccessModule(tid, 'reports');
        allow write: if isOwnerOrAdmin(tid) && canAccessModule(tid, 'reports');
      }
      
      // Catch-all for any other tenant documents
      match /{document=**} {
        allow read, write: if hasTenant(tid);
      }
    }

    // Reference data - public read-only
    match /reference/{document=**} {
      allow read: if true;
      allow write: if false;
    }
    
    // Deny everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
